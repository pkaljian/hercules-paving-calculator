<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Residential Yard Paving Compliance Calculator — Hercules §13-30.750</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121831; --muted:#6b7296; --text:#e6e9f8; --accent:#7aa9ff; --good:#1fbf75; --bad:#ff6b6b; --warn:#ffb44c;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--accent);} .wrap{max-width:1100px;margin:0 auto;padding:28px}
    h1{font-size:1.6rem;margin:0 0 16px} h2{font-size:1.1rem;margin:28px 0 8px;color:#cfd6fb}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .panel{background:var(--panel);border:1px solid #1c2344;border-radius:14px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1.3fr .7fr;gap:10px;align-items:end;margin:8px 0}
    label{font-size:.9rem;color:#c7ccef}
    input[type="number"],select,input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3466;background:#0c1330;color:var(--text)}
    input::placeholder{color:#8590c7}
    .tiny{font-size:.8rem;color:var(--muted)} .inline{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:600}
    .ok{background:rgba(31,191,117,.12);color:#a8f0c9;border:1px solid rgba(31,191,117,.3)}
    .no{background:rgba(255,107,107,.12);color:#ffc9c9;border:1px solid rgba(255,107,107,.3)}
    .warn{background:rgba(255,180,76,.12);color:#ffe4bd;border:1px solid rgba(255,180,76,.3)}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .card{background:#0f1635;border:1px solid #2a3466;border-radius:12px;padding:14px}
    .card h3{margin:0 0 4px;font-size:1rem}
    .kv{display:flex;justify-content:space-between;margin:4px 0;color:#c7ccef}
    .kv b{color:#fff}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{cursor:pointer;background:#1a2350;border:1px solid #31408b;color:#e2e7ff;padding:10px 14px;border-radius:10px;font-weight:600}
    button:hover{background:#202a61}
    .hr{height:1px;background:#243066;margin:14px 0}
    .muted{color:var(--muted)} .msg{margin-top:10px}
    .foot{margin-top:14px;font-size:.9rem;color:#c7ccef}
    .alert{padding:10px;border-radius:10px;margin-top:10px}
    .alert.warn{background:rgba(255,180,76,.12);border:1px solid rgba(255,180,76,.3);color:#ffe4bd}
    .alert.no{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.3);color:#ffc9c9}
    .alert.ok{background:rgba(31,191,117,.12);border:1px solid rgba(31,191,117,.3);color:#a8f0c9}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Residential Yard Paving Compliance Calculator <span class="tiny">(Hercules Municipal Code §13-30.750)</span></h1>

    <div class="grid">
      <!-- 0) Parcel Lookup Panel -->
      <div class="panel">
        <h2>0) Parcel Lookup (APN / Address)</h2>
        <div class="row">
          <label for="apn">Assessor's Parcel Number (APN)</label>
          <input id="apn" type="text" placeholder="e.g., 404-123-015" />
        </div>
        <div class="btns">
          <button id="lookupAPN">Lookup by APN</button>
        </div>
        <div class="hr"></div>
        <div class="row">
          <label for="addr">Street Address (optional)</label>
          <input id="addr" type="text" placeholder="e.g., 123 Palm Ave" />
        </div>
        <div class="btns">
          <button id="lookupADDR">Search by Address (CCMAP)</button>
          <select id="addrChoices" style="display:none"></select>
        </div>
        <div id="apnStatus" class="alert warn" style="display:none"></div>
        <p class="tiny">Auto-fills Lot Area and Building Area (Sq. Ft.) from Contra Costa County Assessor (CCMAP). Verify values before submitting.</p>
      </div>

      <div class="panel">
        <h2>1) Site Basics</h2>
        <div class="row"><label for="lot">Lot area (sf)</label><input id="lot" type="number" min="0" step="0.01" placeholder="e.g., 6,000"/></div>
        <div class="row"><label for="zone">Zoning</label>
          <select id="zone">
            <option value="RS-L">RS-L (Low Density Residential)</option>
            <option value="OTHER">All other residential zones</option>
          </select>
        </div>
        <div class="row"><label for="bldg">Building footprint (impervious; sf)</label><input id="bldg" type="number" min="0" step="0.01" placeholder="e.g., 1,800"/></div>
        <div class="hr"></div>
        <h2>2) Yard Areas (measured plan-view)</h2>
        <div class="row"><label for="frontArea">Front yard area (sf)</label><input id="frontArea" type="number" min="0" step="0.01"/></div>
        <div class="row"><label for="rearSideArea">Rear + side yard combined area (sf)</label><input id="rearSideArea" type="number" min="0" step="0.01"/></div>
        <div id="areaCheck" class="alert warn" style="display:none"></div>
      </div>

      <div class="panel">
        <h2>3) Existing Paving (before project)</h2>
        <div class="row"><label for="frontDrive_exist">Front driveway paving (sf)</label><input id="frontDrive_exist" type="number" min="0" step="0.01"/></div>
        <div class="row"><label for="frontOther_exist">Front walkways & other hardscape (sf)</label><input id="frontOther_exist" type="number" min="0" step="0.01"/></div>
        <div class="row"><label for="rearPave_exist">Rear + side paving (all hardscape; sf)</label><input id="rearPave_exist" type="number" min="0" step="0.01"/></div>
        <div class="row"><label for="imperv_exist">Impermeable paving (subset of above; sf)</label><input id="imperv_exist" type="number" min="0" step="0.01" placeholder="Exclude permeable pavers"/></div>
      </div>

      <div class="panel">
        <h2>4) Proposed Changes (use negative numbers for removals)</h2>
        <div class="row"><label for="frontDrive_delta">Δ Front driveway paving (sf)</label><input id="frontDrive_delta" type="number" step="0.01"/></div>
        <div class="row"><label for="frontOther_delta">Δ Front walkways & hardscape (sf)</label><input id="frontOther_delta" type="number" step="0.01"/></div>
        <div class="row"><label for="rearPave_delta">Δ Rear + side paving (sf)</label><input id="rearPave_delta" type="number" step="0.01"/></div>
        <div class="row"><label for="imperv_delta">Δ Impermeable paving (sf)</label><input id="imperv_delta" type="number" step="0.01" placeholder="+ add / − remove"/></div>

        <div class="btns"><button id="calc">Calculate</button><button id="reset">Reset</button><button id="print">Print / Save PDF</button></div>
        <div id="permit120" class="alert warn" style="display:none"></div>
      </div>

      <div class="panel" id="results" aria-live="polite">
        <h2>Results</h2>
        <div class="cards">
          <div class="card" id="card_front_drive">
            <h3>Front: Driveway ≤ 35% of front yard</h3>
            <div class="kv"><span>Driveway area</span><b id="fd_area">—</b></div>
            <div class="kv"><span>Percent of front yard</span><b id="fd_pct">—</b></div>
            <div class="inline"><span id="fd_badge" class="badge">—</span></div>
          </div>
          <div class="card" id="card_front_other">
            <h3>Front: Walkways & other hardscape ≤ 25%</h3>
            <div class="kv"><span>Other hardscape area</span><b id="fo_area">—</b></div>
            <div class="kv"><span>Percent of front yard</span><b id="fo_pct">—</b></div>
            <div class="inline"><span id="fo_badge" class="badge">—</span></div>
          </div>
          <div class="card" id="card_front_land">
            <h3>Front: Landscaped area ≥ 40%</h3>
            <div class="kv"><span>Landscaped area</span><b id="fl_area">—</b></div>
            <div class="kv"><span>Percent of front yard</span><b id="fl_pct">—</b></div>
            <div class="inline"><span id="fl_badge" class="badge">—</span></div>
          </div>
          <div class="card" id="card_rs_pave">
            <h3>Rear + side: Total paving ≤ 60%</h3>
            <div class="kv"><span>Total paving</span><b id="rs_area">—</b></div>
            <div class="kv"><span>Percent of rear + side</span><b id="rs_pct">—</b></div>
            <div class="inline"><span id="rs_badge" class="badge">—</span></div>
          </div>
          <div class="card" id="card_rs_land">
            <h3>Rear + side: Landscaped area ≥ 40%</h3>
            <div class="kv"><span>Landscaped area</span><b id="rl_area">—</b></div>
            <div class="kv"><span>Percent of rear + side</span><b id="rl_pct">—</b></div>
            <div class="inline"><span id="rl_badge" class="badge">—</span></div>
          </div>
          <div class="card" id="card_storm">
            <h3>Stormwater: Impervious coverage (lot-wide)</h3>
            <div class="kv"><span>Impervious total (bldg + paving)</span><b id="imp_area">—</b></div>
            <div class="kv"><span>Percent of lot</span><b id="imp_pct">—</b></div>
            <div class="inline"><span id="imp_badge" class="badge">—</span></div>
            <div id="imp_note" class="muted msg"></div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="foot">
          <div><strong>Permit trigger:</strong> New paving & hardscape additions over <b>120 sf</b> require a paving permit (Zoning Clearance). <span id="permitLine" class="muted"></span></div>
          <div class="muted">“Landscaped area” excludes pavers, bricks, and other hard surfaces (even if permeable). Calculations are advisory; verify with the City.<br/>
          Source: <a href="https://www.codepublishing.com/CA/Hercules/#!/Hercules13/Hercules1330.html#13-30" target="_blank" rel="noopener">Hercules Municipal Code §13-30.750</a>.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  // ArcGIS Feature Service for Contra Costa County Assessor Parcels (CCMAP)
  // If CORS blocks direct calls from your domain, route requests through a small proxy endpoint.
  const FEATURE_URL = 'https://gis.ccmap.us/arcgis/rest/services/CCMAP/AssessorParcels/MapServer/0/query';
  // Use proxy by default to avoid CORS (Cloudflare Worker route such as '/api/parcel')
  const PROXY_URL = '/api/parcel';
  // ---- Fuzzy address helpers ----
function normAddr(str){
  return (str||'')
    .toUpperCase()
    .replace(/[^A-Z0-9 ]/g,' ')   // drop punctuation
    .replace(/\s+/g,' ')          // collapse spaces
    .trim();
}

// Common street-suffix synonyms
const SUFFIX_MAP = {
  ST:   ['ST','ST.','STREET'],
  RD:   ['RD','RD.','ROAD'],
  AVE:  ['AV','AVE','AVE.','AVENUE'],
  BLVD: ['BLVD','BLVD.','BOULEVARD'],
  CT:   ['CT','CT.','COURT'],
  DR:   ['DR','DR.','DRIVE'],
  LN:   ['LN','LN.','LANE'],
  PL:   ['PL','PL.','PLACE'],
  TER:  ['TER','TER.','TERRACE'],
  WAY:  ['WAY'],
  CIR:  ['CIR','CIR.','CIRCLE'],
  HWY:  ['HWY','HWY.','HIGHWAY'],
  PKWY: ['PKWY','PKWY.','PARKWAY'],
  TRL:  ['TR','TR.','TRL','TRL.','TRAIL']
};

// Build a WHERE clause that ANDs all base tokens and ORs suffix variants
function buildFuzzyWhere(addr){
  const up = normAddr(addr);
  if(!up) return "1=0"; // nothing to search

  const parts = up.split(' ');
  let base = parts.slice();
  let suffixVariants = null;

  // If the last token looks like a suffix, swap it for its variants
  const last = parts[parts.length - 1];
  for (const variants of Object.values(SUFFIX_MAP)){
    if (variants.includes(last)) {
      suffixVariants = variants;
      base = parts.slice(0, -1);
      break;
    }
  }

  const clauses = [];

  // Each base token must appear somewhere
  for (const t of base){
    if (!t) continue;
    clauses.push(`UPPER(SITUSADDRESS) LIKE '%${t.replaceAll("'","''")}%'`);
  }

  // Suffix variants (if detected) — any of them is fine
  if (suffixVariants){
    const ors = suffixVariants
      .map(s => `UPPER(SITUSADDRESS) LIKE '% ${s.replaceAll("'","''")}%'`)
      .join(' OR ');
    clauses.push(`(${ors})`);
  }

  return clauses.length ? clauses.join(' AND ') : "1=0";
}


  const fmt = (n)=> isFinite(n)? new Intl.NumberFormat().format(n): '—';
  const pct = (n)=> isFinite(n)? (n*100).toFixed(1)+'%':'—';
  const badge = (ok, warnText='Complies', failText='Does not comply')=>{
    const span = document.createElement('span');
    span.className = 'badge ' + (ok? 'ok':'no');
    span.textContent = ok? '✔ ' + warnText : '✖ ' + failText;
    return span;
  };

  function readNum(id){
    const v = parseFloat($(id).value); return isNaN(v)? 0 : v;
  }

  function calc(){
    // Basics
    const lot = readNum('lot');
    const zone = $('zone').value;
    const bldg = readNum('bldg');
    const frontArea = readNum('frontArea');
    const rearSideArea = readNum('rearSideArea');

    // Existing
    const fd0 = readNum('frontDrive_exist');
    const fo0 = readNum('frontOther_exist');
    const rs0 = readNum('rearPave_exist');
    const imp0 = readNum('imperv_exist');

    // Deltas
    const fdD = readNum('frontDrive_delta');
    const foD = readNum('frontOther_delta');
    const rsD = readNum('rearPave_delta');
    const impD = readNum('imperv_delta');

    // Totals after
    const fd = Math.max(0, fd0 + fdD);
    const fo = Math.max(0, fo0 + foD);
    const rs = Math.max(0, rs0 + rsD);

    // Landscape (excludes any hard surface)
    const frontLand = Math.max(0, frontArea - (fd + fo));
    const rearLand  = Math.max(0, rearSideArea - rs);

    // %
    const fdPct = frontArea>0 ? fd/frontArea : NaN;
    const foPct = frontArea>0 ? fo/frontArea : NaN;
    const flPct = frontArea>0 ? frontLand/frontArea : NaN;
    const rsPct = rearSideArea>0 ? rs/rearSideArea : NaN;
    const rlPct = rearSideArea>0 ? rearLand/rearSideArea : NaN;

    // Compliance checks
    const fdOK = fdPct <= 0.35 + 1e-9; // Driveway ≤ 35%
    const foOK = foPct <= 0.25 + 1e-9; // Other hardscape ≤ 25%
    const flOK = flPct >= 0.40 - 1e-9; // Landscape ≥ 40%
    const rsOK = rsPct <= 0.60 + 1e-9; // Rear+side paving ≤ 60%
    const rlOK = rlPct >= 0.40 - 1e-9; // Rear+side landscape ≥ 40%

    // Stormwater / impervious
    const imp = Math.max(0, imp0 + impD) + bldg; // impervious paving + building
    const impPct = lot>0 ? imp/lot : NaN;
    const impOver = zone==='RS-L' ? impPct>0.47+1e-9 : false;

    // Permit trigger (only count additions, not removals)
    const added = [fdD, foD, rsD].reduce((s,v)=> s + Math.max(0,v||0), 0);

    // Area sanity check (optional)
    const sumKnown = bldg + frontArea + rearSideArea;
    const areaMsg = (lot>0 && sumKnown>0) ? (Math.abs(sumKnown - lot) <= lot*0.03 ? '' : `Heads up: building + front + rear/side = ${fmt(sumKnown)} sf, which differs from lot area (${fmt(lot)} sf). Double-check your areas.`) : '';

    // Write UI
    $('fd_area').textContent = fmt(fd) + ' sf';
    $('fo_area').textContent = fmt(fo) + ' sf';
    $('rs_area').textContent = fmt(rs) + ' sf';
    $('fl_area').textContent = fmt(frontLand) + ' sf';
    $('rl_area').textContent = fmt(rearLand) + ' sf';

    $('fd_pct').textContent = pct(fdPct);
    $('fo_pct').textContent = pct(foPct);
    $('rs_pct').textContent = pct(rsPct);
    $('fl_pct').textContent = pct(flPct);
    $('rl_pct').textContent = pct(rlPct);

    // Badges
    const setBadge = (id, ok, warn='Complies', fail='Does not comply')=>{
      const host = $(id); host.innerHTML = ''; host.appendChild(badge(ok, warn, fail)); };
    setBadge('fd_badge', fdOK); setBadge('fo_badge', foOK); setBadge('fl_badge', flOK); setBadge('rs_badge', rsOK); setBadge('rl_badge', rlOK);

    $('imp_area').textContent = fmt(imp) + ' sf';
    $('imp_pct').textContent = pct(impPct);
    const impHost = $('imp_badge'); impHost.innerHTML = '';
    if (!isFinite(impPct)) {
      impHost.className = 'badge warn';
      impHost.textContent = 'ℹ Enter lot & impervious inputs';
      $('imp_note').textContent = '';
    } else if (zone==='RS-L' && impOver) {
      impHost.className = 'badge no';
      impHost.textContent = '✖ Exceeds 47% (RS-L) — engineer calculations required';
      $('imp_note').textContent = 'Per §13-30.750(C), if impervious (incl. structures) is > 47% in RS-L, submit civil engineer runoff calcs to the City Engineer.';
    } else {
      impHost.className = 'badge ok';
      impHost.textContent = '✔ Within advisory RS-L threshold';
      $('imp_note').textContent = zone==='OTHER' ? 'For other residential zones, engineer submittal may be required per administrative regulations. Consult the City Engineer.' : '';
    }

    // 120 sf permit note
    const p = $('permit120');
    if (added > 120) {
      p.style.display='block'; p.className = 'alert warn';
      p.textContent = `This project adds approximately ${fmt(added)} sf of new paving/hardscape. A paving permit (Zoning Clearance) is required per §13-30.750(2).`;
    } else if (added>0) {
      p.style.display='block'; p.className = 'alert ok';
      p.textContent = `New paving/hardscape ~ ${fmt(added)} sf (≤ 120 sf). Zoning Clearance not triggered by size threshold.`;
    } else if (added===0) {
      p.style.display='none';
    } else {
      p.style.display='block'; p.className = 'alert ok';
      p.textContent = 'Net reduction in paving — permit size threshold not triggered.';
    }

    // Area check message
    const ac = $('areaCheck');
    if (areaMsg){ ac.style.display='block'; ac.textContent = areaMsg; }
    else { ac.style.display='none'; ac.textContent=''; }

    // Permit line footer
    $('permitLine').textContent = added? ` (your additions: ~${fmt(added)} sf)` : '';
  }

  $('calc').addEventListener('click', calc);

  // ---------- APN Lookup using the Contra Costa CCMAP Feature Service
  async function lookupAPN(){
    const apn = $('apn').value.trim();
    const status = $('apnStatus');
    if(!apn){ status.style.display='block'; status.className='alert warn'; status.textContent='Enter an APN to search (e.g., 404-123-015).'; return; }
    status.style.display='block'; status.className='alert warn'; status.textContent='Looking up parcel…';

    try{
      const where = `APN='${apn.replaceAll("'","''")}'`;
      const params = new URLSearchParams({ where, outFields:'APN,SITUSADDRESS,LOTSQFT,BLDGSQFT', returnGeometry:'false', f:'json' });
      const url = PROXY_URL ? `${PROXY_URL}?${params.toString()}` : `${FEATURE_URL}?${params.toString()}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Network error or CORS blocked');
      const data = await res.json();
      const attrs = data.features && data.features[0] && data.features[0].attributes;
      if(!attrs){ status.className='alert no'; status.textContent='No parcel found for that APN (or parcel is outside City of Hercules).'; return; }

      if (attrs.LOTSQFT) $('lot').value = attrs.LOTSQFT;
      if (attrs.BLDGSQFT) $('bldg').value = attrs.BLDGSQFT;

      const situs = attrs.SITUSADDRESS ? `\nAddress: ${attrs.SITUSADDRESS}` : '';
      if (attrs.SITUSADDRESS && !attrs.SITUSADDRESS.toUpperCase().includes('HERCULES')) {
        status.className = 'alert warn';
        status.textContent = 'Parcel found, but appears outside City of Hercules. ' + `Found APN ${attrs.APN || apn}.` + situs;
      } else {
        status.className='alert ok';
        status.textContent = `Found APN ${attrs.APN || apn}.` + situs;
      }
      window.__lookup = attrs;
      calc();
    }catch(err){ status.className='alert no'; status.textContent='Lookup failed. If this persists, your browser may be blocked by CORS. Use the City network or a proxy endpoint.'; console.error(err); }
  }

  // ---------- Address search via CCMAP attribute query (no geocoder)
  async function lookupAddress(){
    const addr = $('addr').value.trim();
    const status = $('apnStatus');
    const choices = $('addrChoices');
    choices.style.display='none'; choices.innerHTML='';
    if(!addr){ status.style.display='block'; status.className='alert warn'; status.textContent='Enter part of a site address (e.g., number and street name).'; return; }
    status.style.display='block'; status.className='alert warn'; status.textContent='Searching addresses…';

    try{
      const like = `%${addr.toUpperCase().replaceAll("'","''")}%`;
      const where = `UPPER(SITUSADDRESS) LIKE '${like}'`;
      const params = new URLSearchParams({ where, outFields:'APN,SITUSADDRESS,LOTSQFT,BLDGSQFT', returnGeometry:'false', orderByFields:'SITUSADDRESS', resultRecordCount:'25', f:'json' });
      const url = PROXY_URL ? `${PROXY_URL}?${params.toString()}` : `${FEATURE_URL}?${params.toString()}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Network error or CORS blocked');
      const data = await res.json();
      let feats = (data.features||[]).map(f=>f.attributes).filter(Boolean);
      // Hercules-only filter (simplifies public UX). Remove this filter if you want countywide results.
      feats = feats.filter(a => (a.SITUSADDRESS||'').toUpperCase().includes('HERCULES'));

      if(!feats.length){ status.className='alert no'; status.textContent='No matches. Try a simpler address (e.g., number + street name).'; return; }

      feats.slice(0,25).forEach(a=>{
        const opt = document.createElement('option');
        opt.value = JSON.stringify(a);
        opt.textContent = `${a.SITUSADDRESS || 'Unknown'} — APN ${a.APN}`;
        choices.appendChild(opt);
      });
      choices.style.display='inline-block';
      status.className='alert ok'; status.textContent=`Select an address from the list (${feats.length} found).`;
    }catch(err){ status.className='alert no'; status.textContent='Address search failed. If this persists, your browser may be blocked by CORS. Use a proxy endpoint.'; console.error(err); }
  }

  function pickAddress(){
    const status = $('apnStatus');
    const selected = $('addrChoices').value; if(!selected) return;
    const attrs = JSON.parse(selected);
    if (attrs.LOTSQFT) $('lot').value = attrs.LOTSQFT;
    if (attrs.BLDGSQFT) $('bldg').value = attrs.BLDGSQFT;
    $('apn').value = attrs.APN || '';
    status.className='alert ok'; status.textContent = `Loaded ${attrs.SITUSADDRESS || 'selected address'} (APN ${attrs.APN || '—'}).`;
    window.__lookup = attrs;
    calc();
  }

  $('lookupAPN').addEventListener('click', lookupAPN);
  $('lookupADDR').addEventListener('click', lookupAddress);
  $('addrChoices').addEventListener('change', pickAddress);
  $('reset').addEventListener('click', ()=>{ document.querySelectorAll('input').forEach(i=> i.value=''); $('zone').value='RS-L'; $('permit120').style.display='none'; $('areaCheck').style.display='none'; document.querySelectorAll('#results b').forEach(b=> b.textContent='—'); document.querySelectorAll('#results .badge').forEach(s=>{s.className='badge'; s.textContent='—'}); $('imp_note').textContent=''; $('permitLine').textContent=''; });
  $('print').addEventListener('click', ()=> window.print());

  // Auto-calc on input for instant feedback
  document.querySelectorAll('input, select').forEach(el=>{
    el.addEventListener('input', ()=>{ clearTimeout(window.__debounce); window.__debounce = setTimeout(calc, 120); });
  });
</script>
</body>
<!-- ==========================================
Cloudflare Worker proxy (paste into /src/index.js or similar and deploy)
==============================================
This proxy simply forwards query parameters to the CCMAP Feature Service and returns JSON with CORS enabled.
Usage in app: set PROXY_URL = '/api/parcel' and deploy the Worker with a route for '/api/parcel*'.

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    // Base CCMAP layer query endpoint
    const target = new URL('https://gis.ccmap.us/arcgis/rest/services/CCMAP/AssessorParcels/MapServer/0/query');

    // Pass through allowed params only (basic allowlist)
    const allow = new Set(['where','outFields','returnGeometry','orderByFields','resultRecordCount','f']);
    for (const [k,v] of url.searchParams.entries()) {
      if (allow.has(k)) target.searchParams.set(k, v);
    }
    if (!target.searchParams.get('f')) target.searchParams.set('f','json');
    if (!target.searchParams.get('returnGeometry')) target.searchParams.set('returnGeometry','false');

    const upstream = await fetch(target.toString(), { headers: { 'Accept':'application/json' } });
    const body = await upstream.text();

    return new Response(body, {
      status: upstream.status,
      headers: {
        'content-type': 'application/json; charset=utf-8',
        'access-control-allow-origin': '*',
        'access-control-allow-methods': 'GET, OPTIONS',
        'access-control-allow-headers': 'Content-Type'
      }
    });
  }
}

// Optional: add an OPTIONS handler if needed by your platform

-->
</html>

